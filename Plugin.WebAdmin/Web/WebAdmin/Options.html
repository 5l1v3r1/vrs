<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>::WA_Title_Options:: - ::WA_Title_WebAdmin::</title>
        @head.html@
        <script src="../script/webadmin/jquery-ui.js" type="text/javascript"></script>
        <script src="../script/webadmin/knockout.js" type="text/javascript"></script>
        <script src="../script/webadmin/knockout.mapping.js" type="text/javascript"></script>
        <script src="../script/webadmin/jquiplugin/bootstrap-form.js" type="text/javascript"></script>
        <script src="../script/webadmin/jquery.bootstrap-touchspin.js" type="text/javascript"></script>
        <!-- [[ BUNDLE END ]] -->
        <link rel="stylesheet" href="../css/webadmin/jquery.bootstrap-touchspin.css" />
    </head>
    <body>
        <div id="page-container">
            <div id="content" class="container-fluid">
                <div class="row row-offcanvas row-offcanvas-left">
                    <div class="col-xs-12 col-sm-9">
                        <h1 class="page-header">
                            ::WA_Title_Options::
                        </h1>

                        <form>
                            <div id="form-container">

                                <div id="page-receivers" data-vrs-plugin="form-page" data-vrs-title="::Receivers::" data-vrs-icon="images/receiver-32x32.png">
                                    <div data-vrs-bind="Configuration.Receivers" data-vrs-plugin="field-list" data-vrs-bind-selected="selectedReceiver">
                                        <div data-vrs-plugin="list-columns">
                                            <div data-vrs-bind="EnabledYesNo"   data-vrs-title="::Enabled::" data-vrs-class="thin-column"></div>
                                            <div data-vrs-bind="Name"           data-vrs-title="::Name::"></div>
                                            <div data-vrs-bind="DataSourceText" data-vrs-title="::Format::"></div>
                                        </div>
                                        <div data-vrs-plugin="list-detail">
                                            <div data-vrs-bind="Enabled"            data-vrs-title="::Enabled::"        data-vrs-plugin="field-checkbox"></div>
                                            <div data-vrs-bind="Name"               data-vrs-title="::Name::"           data-vrs-plugin="field-text"></div>
                                            <div data-vrs-bind="DataSource"         data-vrs-title="::Format::"         data-vrs-plugin="field-select" data-vrs-bind-options="$root.DataSources" data-vrs-options-text="item.Name" data-vrs-options-value="item.Value"></div>
                                            <div data-vrs-bind="ReceiverLocationId" data-vrs-title="::Location::"       data-vrs-plugin="field-select" data-vrs-bind-options="$root.Configuration.ReceiverLocations" data-vrs-options-text="item.Name" data-vrs-options-value="item.UniqueId" data-vrs-field-flags="allowUnset"></div>
                                            <div data-vrs-bind="ConnectionType"     data-vrs-title="::ConnectionType::" data-vrs-plugin="field-select" data-vrs-bind-options="$root.ConnectionTypes" data-vrs-options-text="item.Name" data-vrs-options-value="item.Value"></div>

                                            <div data-vrs-title="::Network::" data-vrs-plugin="field-panel" data-vrs-bind-visible="IsNetworkConnectionType">
                                                <div data-vrs-bind="IsPassive"          data-vrs-title="::PassiveReceiver::"    data-vrs-plugin="field-checkbox"></div>
                                                <div data-vrs-bind="Address"            data-vrs-title="::UNC::"                data-vrs-plugin="field-text" data-vrs-bind-disable="IsPassive"></div>
                                                <div data-vrs-bind="Port"               data-vrs-title="::Port::"               data-vrs-plugin="field-numeric" data-vrs-min="1" data-vrs-max="65535"></div>
                                                <div data-vrs-bind="Passphrase"         data-vrs-title="::Passphrase::"         data-vrs-plugin="field-text"></div>
                                                <div data-vrs-bind="UseKeepAlive"       data-vrs-title="::UseKeepAlive::"       data-vrs-plugin="field-checkbox"></div>
                                                <div data-vrs-bind="IdleTimeoutSeconds" data-vrs-title="::IdleTimeout::"        data-vrs-plugin="field-numeric" data-vrs-bind-disable="UseKeepAlive" data-vrs-min="5" data-vrs-max="86400" data-vrs-suffix="::PSeconds::"></div>
                                            </div>

                                            <div data-vrs-title="::USBOverCOM::" data-vrs-plugin="field-panel"     data-vrs-bind-visible="IsSerialConnectionType">
                                                <div data-vrs-bind="ComPort"        data-vrs-title="::SerialComPort::"      data-vrs-plugin="field-select" data-vrs-bind-options="$root.SerialPortNames"></div>
                                                <div data-vrs-bind="BaudRate"       data-vrs-title="::SerialBaudRate::"     data-vrs-plugin="field-select" data-vrs-bind-options="$root.BaudRates"></div>
                                                <div data-vrs-bind="DataBits"       data-vrs-title="::SerialDataBits::"     data-vrs-plugin="field-select" data-vrs-bind-options="$root.DataBits"></div>
                                                <div data-vrs-bind="StopBits"       data-vrs-title="::SerialStopBits::"     data-vrs-plugin="field-select" data-vrs-bind-options="$root.StopBits" data-vrs-options-text="item.Name" data-vrs-options-value="item.Value"></div>
                                                <div data-vrs-bind="Parity"         data-vrs-title="::SerialParity::"       data-vrs-plugin="field-select" data-vrs-bind-options="$root.Parities" data-vrs-options-text="item.Name" data-vrs-options-value="item.Value"></div>
                                                <div data-vrs-bind="Handshake"      data-vrs-title="::SerialHandshake::"    data-vrs-plugin="field-select" data-vrs-bind-options="$root.Handshakes" data-vrs-options-text="item.Name" data-vrs-options-value="item.Value"></div>
                                                <div data-vrs-bind="StartupText"    data-vrs-title="::SerialStartupText::"  data-vrs-plugin="field-text"></div>
                                                <div data-vrs-bind="ShutdownText"   data-vrs-title="::SerialShutdownText::" data-vrs-plugin="field-text"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="page-data-sources" data-vrs-plugin="form-page" data-vrs-title="::OptionsDataSourcesSheetTitle::" data-vrs-icon="images/notebook-32x32.png">
                                    <div data-vrs-bind="Configuration.BaseStationSettings.DatabaseFileName"         data-vrs-title="::DatabaseFileName::"           data-vrs-plugin="field-text" data-vrs-validation-field="BaseStationDatabase"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.OperatorFlagsFolder"      data-vrs-title="::FlagsFolder::"                data-vrs-plugin="field-text" data-vrs-validation-field="FlagsFolder"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.SilhouettesFolder"        data-vrs-title="::SilhouettesFolder::"          data-vrs-plugin="field-text" data-vrs-validation-field="SilhouettesFolder"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.PicturesFolder"           data-vrs-title="::PicturesFolder::"             data-vrs-plugin="field-text" data-vrs-validation-field="PicturesFolder"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.SearchPictureSubFolders"  data-vrs-title="::SearchPictureSubFolders::"    data-vrs-plugin="field-checkbox"></div>
                                </div>

                                <div id="page-general" data-vrs-plugin="form-page" data-vrs-title="::General::" data-vrs-icon="images/gear-32x32.png">
                                    <h5>::OptionsGeneralCategory::</h5>
                                    <div data-vrs-bind="Configuration.FlightRouteSettings.AutoUpdateEnabled"            data-vrs-title="::AutomaticallyDownloadNewRoutes::" data-vrs-plugin="field-checkbox"></div>
                                    <div data-vrs-bind="Configuration.VersionCheckSettings.CheckAutomatically"          data-vrs-title="::CheckForNewVersions::"            data-vrs-plugin="field-checkbox"></div>
                                    <div data-vrs-bind="Configuration.VersionCheckSettings.CheckPeriodDays"             data-vrs-title="::DaysBetweenChecks::"              data-vrs-plugin="field-numeric" data-vrs-min="0" data-vrs-max="365"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.DisplayTimeoutSeconds"        data-vrs-title="::RemoveFromDisplay::"              data-vrs-plugin="field-numeric" data-vrs-min="5" data-vrs-max="540" data-vrs-suffix="::PSeconds::"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.TrackingTimeoutSeconds"       data-vrs-title="::RemoveFromTracking::"             data-vrs-plugin="field-numeric" data-vrs-min="5" data-vrs-max="3600" data-vrs-suffix="::PSeconds::"></div>
                                    <div data-vrs-bind="Configuration.GoogleMapSettings.ShortTrailLengthSeconds"        data-vrs-title="::ShortTrailDuration::"             data-vrs-plugin="field-numeric" data-vrs-min="1" data-vrs-max="1800" data-vrs-suffix="::PSeconds::"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.AutoSavePolarPlotsMinutes"    data-vrs-title="::AutoSavePolarPlots::"             data-vrs-plugin="field-numeric" data-vrs-min="1" data-vrs-max="43200" data-vrs-suffix="::PMinutes::"></div>
                                    <div data-vrs-bind="Configuration.BaseStationSettings.MinimiseToSystemTray"         data-vrs-title="::MinimiseToSystemTray::"           data-vrs-plugin="field-checkbox"></div>

                                    <h5 data-bind="visible: RunningDotNet">::Audio::</h5>
                                    <div id="audio-options" data-bind="visible: RunningDotNet">
                                        <div data-vrs-bind="Configuration.AudioSettings.Enabled"    data-vrs-title="::Enabled::"            data-vrs-plugin="field-checkbox"></div>
                                        <div data-vrs-bind="Configuration.AudioSettings.VoiceName"  data-vrs-title="::TextToSpeechVoice::"  data-vrs-plugin="field-select" data-vrs-bind-options="VoiceNames"></div>
                                        <div data-vrs-bind="Configuration.AudioSettings.VoiceRate"  data-vrs-title="::ReadingSpeed::"       data-vrs-plugin="field-numeric" data-vrs-min="-10" data-vrs-max="10"></div>
                                    </div>
                                </div>

                            </div>
                            <div>
                                Revision: <span data-bind="text: Configuration.DataVersion"></span>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function(VRS, $, undefined)
            {
                //region Fields that aren't related to viewmodel mapping
                var _FormPlugin;
                //endregion

                //region ViewModel mapping options
                var _ViewModel = {};
                var _ViewMapping = {
                    create: function(options)
                    {
                        var model = ko.mapping.fromJS(options.data);

                        model.RunningDotNet = ko.computed(function() { return !this.RunningMono(); }, model);

                        var lookupNameFromValue = function(value, nameValues) {
                            var result = null;
                            $.each(nameValues, function(idx, nameValue) {
                                if(nameValue.Value === value) {
                                    result = nameValue.Name;
                                }
                                return result === null;
                            });

                            return result === null ? '' : result;
                        };

                        model.selectedReceiver = ko.observable(undefined);

                        $.each(model.Configuration.Receivers(), function(idx, receiver) {
                            receiver.EnabledYesNo = ko.computed(function() {
                                return this.Enabled() ? '::Yes::' : '::No::'
                            }, receiver);
                            receiver.DataSourceText = ko.computed(function() {
                                var dataSource = this.DataSource();
                                return lookupNameFromValue(dataSource, options.data.DataSources);
                            }, receiver);
                            receiver.IsNetworkConnectionType = ko.computed(function() {
                                return this.ConnectionType() === 0;
                            }, receiver);
                            receiver.IsSerialConnectionType = ko.computed(function() {
                                return this.ConnectionType() === 1;
                            }, receiver);
                            receiver.IdleTimeoutSeconds = ko.pureComputed({
                                read:  function() { return this.IdleTimeoutMilliseconds() / 1000; },
                                write: function(value) { this.IdleTimeoutMilliseconds(value * 1000); },
                                owner: this
                            }, receiver);
                        });

                        return model;
                    }
                };
                //endregion

                //region SettingsView
                VRS.WebAdmin.SettingsView = function(settings)
                {
                    VRS.WebAdmin.View.call(this, settings);

                    this.addElements = function()
                    {
                        var form = $('#form-container');
                        form.bootstrapForm();
                        _FormPlugin = VRS.jQueryUIHelper.getBootstrapFormPlugin(form);
                    };

                    /**
                     * Shows the content sent from the server.
                     * @param {VRS_WEBADMIN_VIEWDATA_SETTINGS} data
                     */
                    this.showContent = function(data)
                    {
                        _ViewModel = ko.mapping.fromJS(data, _ViewMapping);
                        ko.applyBindings(_ViewModel);
                        _FormPlugin.showValidationResults(data.ValidationResults);
                    };
                };
                VRS.WebAdmin.SettingsView.prototype = VRS.objectHelper.subclassOf(VRS.WebAdmin.View);
                //endregion

                var settingsView = new VRS.WebAdmin.SettingsView({
                    pageUrl: 'Options.html',
                    jsonUrl: 'Options.json',
                    refreshPeriod: 0
                });
                settingsView.initialise();
            }(window.VRS = window.VRS || {}, jQuery));
        </script>
    </body>
</html>
