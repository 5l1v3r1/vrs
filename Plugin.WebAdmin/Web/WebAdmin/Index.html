<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>::WA_Title_Main:: - ::WA_Title_WebAdmin::</title>
        @head.html@
    </head>
    <body>
        <div id="page-container">
            <div id="content" class="container-fluid">
                <div class="row row-offcanvas row-offcanvas-left">
                    <div class="col-xs-12 col-sm-9">
                        <h1 class="page-header">
                            ::WA_Title_Main::
                        </h1>

                        <div id="newVersion" class="alert alert-info" role="alert" style="display: none">
                            <a href="#" target="external">::LaterVersionAvailable::</a>
                        </div>

                        <div id="panel-feeds" class="panel panel-default" role="tablist">
                            <div id="feeds-heading" class="panel-heading" role="tab" aria-expanded="true" aria-controls="feeds-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#feeds-collapse" href="#feeds-collapse">
                                        ::FeedStatus::
                                    </a>
                                </h4>
                            </div>
                            <div id="feeds-collapse" class="pabel-collapse collapse in" role="tabpanel" aria-labelledby="feeds-heading">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table id="feeds-table" class="table table-striped table-condensed">
                                            <thead>
                                                <tr>
                                                    <th>::NameTitle::</th>
                                                    <th>::WA_Title_Status::</th>
                                                    <th class="text-right">::WA_Title_Messages::</th>
                                                    <th class="text-right">::WA_Title_Bad::</th>
                                                    <th class="text-right">::WA_Title_Tracking::</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="panel-rebroadcasters" class="panel panel-default" role="tablist">
                            <div id="rebroadcasters-heading" class="panel-heading" role="tab" aria-expanded="true" aria-controls="feeds-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#rebroadcasters-collapse" href="#rebroadcasters-collapse">
                                        ::RebroadcastServersLabel::
                                    </a>
                                </h4>
                            </div>
                            <div id="rebroadcasters-collapse" class="pabel-collapse collapse in" role="tabpanel" aria-labelledby="rebroadcasters-heading">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table id="rebroadcasters-table" class="table table-striped table-condensed">
                                            <thead>
                                            <tr>
                                                <th>::NameTitle::</th>
                                                <th>::IPAddress::</th>
                                                <th>::Port::</th>
                                                <th class="text-right">::WA_Title_Buffered::</th>
                                                <th class="text-right">::WA_Title_Sent::</th>
                                                <th class="text-right">::WA_Title_Discarded::</th>
                                            </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="panel-upnp" class="panel panel-default" role="tablist">
                            <div class="panel-heading" role="tab" id="upnp-heading" aria-expanded="true" aria-controls="upnp-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#upnp-collapse" href="#upnp-collapse">
                                        ::WA_Title_Upnp::
                                    </a>
                                </h4>
                            </div>
                            <div id="upnp-collapse" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="panel-heading">
                                <div class="panel-body">
                                    <p id="upnp-status"></p>
                                    <div>
                                        <button id="upnp-toggle" type="button" class="btn btn-primary"></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="panel-address" class="panel panel-default" role="tablist">
                            <div class="panel-heading" role="tab" id="address-heading" aria-expanded="true" aria-controls="address-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#address-collapse" href="#address-collapse">
                                        ::UNC::
                                    </a>
                                </h4>
                            </div>
                            <div id="address-collapse" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="address-heading">
                                <div class="panel-body">
                                    <p>
                                        <select id="address-perspective" class="ui-inline">
                                            <option value="local">::ShowLocalAddress::</option>
                                            <option value="network">::ShowNetworkAddress::</option>
                                            <option value="public">::ShowInternetAddress::</option>
                                        </select>
                                    </p>
                                    <p>
                                        <select id="address-page">
                                            <option value="/">::DefaultVersion::</option>
                                            <option value="/desktop.html">::DesktopVersion::</option>
                                            <option value="/mobile.html">::MobileVersion::</option>
                                            <option value="/fsx.html">::FlightSimVersion::</option>
                                            <option value="/GoogleMap.htm">::DesktopVersionOld::</option>
                                            <option value="/iPhoneMap.htm">::MobileVersionOld::</option>
                                            <option value="/FlightSim.htm">::FlightSimVersionOld::</option>
                                            <option value="/settings.html">::SettingsPage::</option>
                                        </select>
                                    </p>
                                    <p>
                                        <a id="address-link" href="#" target="livesite"></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function(VRS, $, undefined)
            {
                //region MainView
                VRS.WebAdmin.MainView = function(settings)
                {
                    VRS.WebAdmin.View.call(this, settings);
                    var that = this;

                    // Feed fields
                    var _FeedTableBody = $('tbody', '#feeds-table');

                    // Rebroadcast server fields
                    var _RebroadcastersBody = $('tbody', '#rebroadcasters-table');

                    // UPnP fields
                    var _UPnpEnabled = false;
                    var _UPnpRouterPresent = false;
                    var _UPnpActive = false;
                    var _UpnpStatus = $('#upnp-status');
                    var _UpnpToggle = $('#upnp-toggle');

                    // Address fields
                    var _AddressLocalRoot = null;
                    var _AddressLanRoot = null;
                    var _AddressPublicRoot = null;
                    var _AddressPerspective = $('#address-perspective');
                    var _AddressPage = $('#address-page');
                    var _AddressLink = $('#address-link');

                    /**
                     * Hooks events
                     */
                    this.hookEvents = function()
                    {
                        _UpnpToggle.on('click', function() { that.raiseViewEventInBackground('toggle-upnp-status'); });
                        _AddressPerspective.on('change', function() { showAddress(); });
                        _AddressPage.on('change', function() { showAddress(); });
                    };

                    /**
                     * Performs first-time initialisation of the view.
                     */
                    this.initialiseContent = function()
                    {
                        showUpnpState();
                    };

                    /**
                     * Shows the content sent from the server.
                     * @param {VRS_WEBADMIN_VIEWDATA_MAIN} data
                     */
                    this.showContent = function(data)
                    {
                        refreshFeeds(data);
                        refreshRebroadcasters(data);
                        refreshUpnp(data);
                        refreshAddresses(data);
                        refreshVersionCheck(data);
                    };

                    function refreshFeeds(data)
                    {
                        _FeedTableBody.empty();
                        $.each(data.Feeds, function(/** number */ idx, /** VRS_WEBADMIN_VIEWDATA_FEEDSTATUS */ feed) {
                            var row = $('<tr />')
                                .append($('<td />').text(feed.Name))
                                .append($('<td />').text(feed.ConnDesc))
                                .append($('<td />').text(VRS.stringUtility.formatNumber(feed.Msgs, '0,000')).addClass('text-right'))
                                .append($('<td />').text(feed.BadMsgs).addClass('text-right'))
                                .append($('<td />').text(feed.Tracked).addClass('text-right'));
                            _FeedTableBody.append(row);
                        });
                    }

                    function refreshRebroadcasters(data)
                    {
                        _RebroadcastersBody.empty();
                        $.each(data.Rebroadcasters, function(/** number */ idx, /** VRS_WEBADMIN_VIEWDATA_REBROADCAST_SERVER_CONNECTION */ rebroadcaster) {
                            var row = $('<tr />')
                                    .append($('<td />').text(rebroadcaster.Name))
                                    .append($('<td />').text(rebroadcaster.RemoteAddr + ':' + rebroadcaster.RemotePort))
                                    .append($('<td />').text(rebroadcaster.LocalPort))
                                    .append($('<td />').text(VRS.stringUtility.formatNumber(rebroadcaster.Buffered, '0,000')).addClass('text-right'))
                                    .append($('<td />').text(VRS.stringUtility.formatNumber(rebroadcaster.Written, '0,000')).addClass('text-right'))
                                    .append($('<td />').text(VRS.stringUtility.formatNumber(rebroadcaster.Discarded, '0,000')).addClass('text-right'));
                            _RebroadcastersBody.append(row);
                        });
                    }

                    function refreshUpnp(data)
                    {
                        if(_UPnpEnabled !== data.Upnp || _UPnpRouterPresent !== data.UpnpRouter || _UPnpActive !== data.UpnpOn) {
                            _UPnpEnabled = data.Upnp;
                            _UPnpRouterPresent = data.UpnpRouter;
                            _UPnpActive = data.UpnpOn;
                            showUpnpState();
                        }
                    }

                    function showUpnpState()
                    {
                        var status = !_UPnpEnabled && _UPnpActive ? '::UPnpActiveWhileDisabled::' :
                                     !_UPnpEnabled ? '::UPnpDisabled::' :
                                     !_UPnpRouterPresent ? '::UPnPNotPresent::' :
                                     !_UPnpActive ? '::UPnpInactive::' :
                                     '::UPnpActive::';

                        _UpnpStatus.text(status);
                        _UpnpToggle.text(_UPnpActive ? '::TakeOffInternet::' : '::PutOnInternet::');
                        _UpnpToggle.prop('disabled', !(_UPnpEnabled && _UPnpRouterPresent));
                    }

                    /**
                     * Refreshes the server addresses.
                     * @param data
                     */
                    function refreshAddresses(data)
                    {
                        if(data.LocalRoot !== _AddressLocalRoot || data.LanRoot !== _AddressLanRoot || data.PublicRoot !== _AddressPublicRoot) {
                            _AddressLocalRoot = data.LocalRoot;
                            _AddressLanRoot = data.LanRoot;
                            _AddressPublicRoot = data.PublicRoot;
                            showAddress();
                        }
                    }

                    /**
                     * Fills the address link.
                     */
                    function showAddress()
                    {
                        var root;
                        switch(_AddressPerspective.val()) {
                            case 'local':   root = _AddressLocalRoot; break;
                            case 'network': root = _AddressLanRoot; break;
                            case 'public':  root = _AddressPublicRoot; break;
                        }

                        var page = _AddressPage.val();

                        var url = '#';
                        var text = '::NotYetKnown::';
                        if(root && page) {
                            url = root + page;
                            text = url;
                        }

                        _AddressLink.attr('href', url);
                        _AddressLink.text(text);
                    }

                    /**
                     * Refreshes the display of the version check result.
                     * @param data
                     */
                    function refreshVersionCheck(data)
                    {
                        var alert = $('#newVersion');
                        var currentState = alert.is(':visible');
                        if(currentState !== data.NewVer) {
                            var link = $('a', alert);
                            link.attr('href', data.NewVer ? data.NewVerUrl : '#');
                            alert.toggle(data.NewVer);
                        }
                    }
                };
                VRS.WebAdmin.MainView.prototype = VRS.objectHelper.subclassOf(VRS.WebAdmin.View);
                //endregion

                var mainView = new VRS.WebAdmin.MainView({
                    pageUrl: 'Index.html',
                    pageId: 'main-page',
                    jsonUrl: 'Index.json'
                });
                mainView.initialise();
            }(window.VRS = window.VRS || {}, jQuery));
        </script>
    </body>
</html>