<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>::WA_Title_Main:: - ::WA_Title_WebAdmin::</title>
        @head.html@
    </head>
    <body>
        <div id="page-container">
            <div id="content" class="container-fluid">
                <div class="row row-offcanvas row-offcanvas-left">
                    <div class="col-xs-12 col-sm-9">
                        <h1 class="page-header">
                            ::WA_Title_Main::
                        </h1>

                        <div id="newVersion" class="alert alert-info" role="alert" style="display: none">
                            <a href="#" target="external">::LaterVersionAvailable::</a>
                        </div>

                        <div class="panel panel-default" id="panel-feeds" role="tablist">
                            <div class="panel-heading" role="tab" id="feeds-heading" aria-expanded="true" aria-controls="feeds-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#feeds-collapse" href="#feeds-collapse">
                                        ::FeedStatus::
                                    </a>
                                </h4>
                            </div>
                            <div id="feeds-collapse" class="pabel-collapse collapse in" role="tabpanel" aria-labelledby="feeds-heading">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table id="feeds-table" class="table table-striped table-condensed">
                                            <thead>
                                                <tr>
                                                    <th>::NameTitle::</th>
                                                    <th>::WA_Title_Status::</th>
                                                    <th class="text-right">::WA_Title_Messages::</th>
                                                    <th class="text-right">::WA_Title_Bad::</th>
                                                    <th class="text-right">::WA_Title_Tracking::</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default" id="panel-upnp" role="tablist">
                            <div class="panel-heading" role="tab" id="upnp-heading" aria-expanded="true" aria-controls="upnp-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#upnp-collapse" href="#upnp-collapse">
                                        ::WA_Title_Upnp::
                                    </a>
                                </h4>
                            </div>
                            <div id="upnp-collapse" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="panel-heading">
                                <div class="panel-body">
                                    <p id="upnp-status"></p>
                                    <div>
                                        <button id="upnp-toggle" type="button" class="btn btn-primary"></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default" id="panel-address" role="tablist">
                            <div class="panel-heading" role="tab" id="address-heading" aria-expanded="true" aria-controls="address-collapse">
                                <h4>
                                    <a class="" data-toggle="collapse" data-target="#address-collapse" href="#address-collapse">
                                        ::UNC::
                                    </a>
                                </h4>
                            </div>
                            <div id="address-collapse" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="address-heading">
                                <div class="panel-body">
                                    <p>
                                        <select id="main-address-perspective" class="ui-inline">
                                            <option value="local">::ShowLocalAddress::</option>
                                            <option value="network">::ShowNetworkAddress::</option>
                                            <option value="public">::ShowInternetAddress::</option>
                                        </select>
                                    </p>
                                    <p>
                                        <select id="main-address-page">
                                            <option value="default">::DefaultVersion::</option>
                                            <option value="desktop">::DesktopVersion::</option>
                                            <option value="mobile">::MobileVersion::</option>
                                            <option value="fsx">::FlightSimVersion::</option>
                                            <option value="oldDesktop">::DesktopVersionOld::</option>
                                            <option value="oldMobile">::MobileVersionOld::</option>
                                            <option value="oldFsx">::FlightSimVersionOld::</option>
                                            <option value="settings">::SettingsPage::</option>
                                        </select>
                                    </p>
                                    <p>
                                        <a id="main-site-link" href="#" target="livesite"></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function(VRS, $, undefined)
            {
                //region MainView
                VRS.WebAdmin.MainView = function(settings)
                {
                    VRS.WebAdmin.View.call(this, settings);
                    var that = this;

                    // Feed fields
                    var _FeedTableBody = $('tbody', '#feeds-table');

                    // UPnP fields
                    var _UPnpEnabled = false;
                    var _UPnpRouterPresent = false;
                    var _UPnpActive = false;
                    var _UpnpStatus = $('#upnp-status');
                    var _UpnpToggle = $('#upnp-toggle');

                    /**
                     * Hooks events
                     */
                    this.hookEvents = function()
                    {
                        _UpnpToggle.on('click', function() { upnpToggle_Click(); });
                    };

                    /**
                     * Performs first-time initialisation of the view.
                     */
                    this.initialiseContent = function()
                    {
                        showUpnpState();
                    };

                    /**
                     * Shows the content sent from the server.
                     * @param {VRS_WEBADMIN_VIEWDATA_MAIN} data
                     */
                    this.showContent = function(data)
                    {
                        refreshFeeds(data);
                        refreshUpnp(data);
                        refreshAddresses(data);
                        refreshVersionCheck(data);
                    };

                    function refreshFeeds(data)
                    {
                        _FeedTableBody.empty();
                        $.each(data.Feeds, function(/** number */ idx, /** VRS_WEBADMIN_VIEWDATA_FEEDSTATUS */ feed) {
                            var row = $('<tr />')
                                .append($('<td />').text(feed.Name))
                                .append($('<td />').text(feed.ConnDesc))
                                .append($('<td />').text(VRS.stringUtility.formatNumber(feed.Msgs, '0,000')).addClass('text-right'))
                                .append($('<td />').text(feed.BadMsgs).addClass('text-right'))
                                .append($('<td />').text(feed.Tracked).addClass('text-right'));
                            _FeedTableBody.append(row);
                        });
                    }

                    function refreshUpnp(data)
                    {
                        if(_UPnpEnabled !== data.Upnp || _UPnpRouterPresent !== data.UpnpRouter || _UPnpActive !== data.UpnpOn) {
                            _UPnpEnabled = data.Upnp;
                            _UPnpRouterPresent = data.UpnpRouter;
                            _UPnpActive = data.UpnpOn;
                            showUpnpState();
                        }
                    }

                    function showUpnpState()
                    {
                        var status = !_UPnpEnabled && _UPnpActive ? '::UPnpActiveWhileDisabled::' :
                                     !_UPnpEnabled ? '::UPnpDisabled::' :
                                     !_UPnpRouterPresent ? '::UPnPNotPresent::' :
                                     !_UPnpActive ? '::UPnpInactive::' :
                                     '::UPnpActive::';

                        _UpnpStatus.text(status);
                        _UpnpToggle.text(_UPnpActive ? '::TakeOffInternet::' : '::PutOnInternet::');
                        _UpnpToggle.prop('disabled', !(_UPnpEnabled && _UPnpRouterPresent));
                    }

                    function upnpToggle_Click()
                    {
                        that.raiseViewEventInBackground('toggle-upnp-status');
                    }

                    /**
                     * Refreshes the server addresses.
                     * @param data
                     */
                    function refreshAddresses(data)
                    {
                        var siteLink = $('#main-site-link');
                        if(siteLink.text() !== data.LocalRoot) {
                            siteLink.text(data.LocalRoot);
                            siteLink.attr('href', data.LocalRoot);
                        }
                    }

                    /**
                     * Refreshes the display of the version check result.
                     * @param data
                     */
                    function refreshVersionCheck(data)
                    {
                        var alert = $('#newVersion');
                        var currentState = alert.is(':visible');
                        if(currentState !== data.NewVer) {
                            var link = $('a', alert);
                            link.attr('href', data.NewVer ? data.NewVerUrl : '#');
                            alert.toggle(data.NewVer);
                        }
                    }
                };
                VRS.WebAdmin.MainView.prototype = VRS.objectHelper.subclassOf(VRS.WebAdmin.View);
                //endregion

                var mainView = new VRS.WebAdmin.MainView({
                    pageUrl: 'Index.html',
                    pageId: 'main-page',
                    jsonUrl: 'Index.json'
                });
                mainView.initialise();
            }(window.VRS = window.VRS || {}, jQuery));
        </script>
    </body>
</html>