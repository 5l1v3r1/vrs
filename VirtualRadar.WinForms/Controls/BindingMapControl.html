<!DOCTYPE html>
<html>
<head>
    <title>Location Map</title>
    <style type="text/css">
        html            { height: 100%; }
        body            { height: 100%; margin: 0; padding: 0; font-family: Verdana, Sans-Serif; font-size: 0.9em; }
        #map            { height: 100%; width: 100%; }
        #map.failed     { background: #FFFFFF; position: relative; }
        #map.failed div { text-align:center; width: 100%; position: absolute; top: 50%; }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">
        var highContrastMapStyle = [ // The Google map styles to use for the high contrast map.
            {
                featureType: 'poi',
                stylers: [
                    { visibility: 'off' }
                ]
            },{
                featureType: 'landscape',
                stylers: [
                    { saturation: -70 },
                    { lightness: -30 },
                    { gamma: 0.80 }
                ]
            },{
                featureType: 'road',
                stylers: [
                    { visibility: 'simplified' },
                    { weight: 0.4 },
                    { saturation: -70 },
                    { lightness: -30 },
                    { gamma: 0.80 }
                ]
            },{
                featureType: 'road',
                elementType: 'labels',
                stylers: [
                    { visibility: 'simplified' },
                    { saturation: -46 },
                    { gamma: 1.82 }
                ]
            },{
                featureType: 'administrative',
                stylers: [
                    { weight: 1 }
                ]
            },{
                featureType: 'administrative',
                elementType: 'labels',
                stylers: [
                    { saturation: -100 },
                    { weight: 0.1 },
                    { lightness: -60 },
                    { gamma: 2.0 }
                ]
            },{
                featureType: 'water',
                stylers: [
                    { saturation: -72 },
                    { lightness: -25 }
                ]
            },{
                featureType: 'administrative.locality',
                stylers: [
                    { weight: 0.1 }
                ]
            },{
                featureType: 'administrative.province',
                stylers: [
                    { lightness: -43 }
                ]
            },{
                "featureType": "transit.line",
                "stylers": [
                    { "visibility": "off" }
                ]
            },{
                "featureType": "transit.station.bus",
                "stylers": [
                    { "visibility": "off" }
                ]
            },{
                "featureType": "transit.station.rail",
                "stylers": [
                    { "visibility": "off" }
                ]
            }
        ];

        var googleMap;
        var googleMapMarker;
        var failedToLoad = 'Failed to load';
        var contrastMapName = 'Contrast';
        var latitude = 0.0;
        var longitude = 0.0;
        var mapType = 'ROADMAP';
        var zoomLevel = 10;
        var highContrastMap;

        function showErrorMessage(errorMessage)
        {
            map.innerHTML = '<div>' + errorMessage + '</div>';
            map.className = 'failed';
        }

        function initialiseFromForm()
        {
            var result = true;

            try {
                failedToLoad = window.external.BrowserGetFailedErrorText();
                contrastMapName = window.external.BrowserHighContrastText();
                latitude = window.external.BrowserGetLatitude();
                longitude = window.external.BrowserGetLongitude();
                mapType = window.external.BrowserGetMapType();
                if(mapType !== 'HIGHCONTRAST') mapType = google.maps.MapTypeId[mapType];
                zoomLevel = window.external.BrowserGetZoomLevel();
            } catch(exception) {
                showErrorMessage('Could not talk to form: ' + exception);
                result = false;
            }

            return result;
        }

        function setPositionFromForm(lat, lng)
        {
            if(googleMapMarker) {
                latitude = lat;
                longitude = lng;
                try {
                    var latLng = new google.maps.LatLng(latitude, longitude);
                    googleMapMarker.setPosition(latLng);
                    googleMap.setCenter(latLng);
                } catch(exception) {
                    ;
                }
            }
        }

        function sendPositionToForm()
        {
            try {
                window.external.BrowserSetPosititon(latitude, longitude);
            } catch(exception) {
                ;
            }
        }

        function setMapTypeFromForm(type)
        {
            if(googleMap) {
                mapType = type;
                var isCustom = mapType === 'HIGHCONTRAST';
                googleMap.setMapTypeId(isCustom ? mapType : google.maps.MapTypeId[mapType]);
            }
        }

        function sendMapTypeToForm()
        {
            try {
                window.external.BrowserSetMapType(mapType.toString().toUpperCase());
            } catch(exception) {
                ;
            }
        }

        function setZoomLevelFromForm(level)
        {
            if(googleMap) {
                zoomLevel = level;
                googleMap.setZoom(zoomLevel);
            }
        }

        function sendZoomLevelToForm()
        {
            try {
                window.external.BrowserSetZoomLevel(zoomLevel);
            } catch(exception) {
                ;
            }
        }

        window.onload = function() {
            if(initialiseFromForm()) {
                var map = document.getElementById('map');
                try {
                    googleMap = new google.maps.Map(map, {
                        center:                 new google.maps.LatLng(latitude, longitude),
                        streetViewControl:      false,
                        zoom:                   zoomLevel,
                        zoomControl:            true,
                        mapTypeControlOptions:  {
                            style:          google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                            mapTypeIds:     [
                                google.maps.MapTypeId.HYBRID,
                                google.maps.MapTypeId.ROADMAP,
                                google.maps.MapTypeId.SATELLITE,
                                google.maps.MapTypeId.TERRAIN,
                                'HIGHCONTRAST'
                            ]
                        }
                    });

                    highContrastMap = new google.maps.StyledMapType(highContrastMapStyle, { name: contrastMapName });
                    googleMap.mapTypes.set('HIGHCONTRAST', highContrastMap);
                    googleMap.setMapTypeId(mapType);

                    google.maps.event.addListener(googleMap, 'maptypeid_changed', function() {
                        mapType = googleMap.getMapTypeId();
                        sendMapTypeToForm();
                    });
                    google.maps.event.addListener(googleMap, 'zoom_changed', function() {
                        zoomLevel = googleMap.getZoom();
                        sendZoomLevelToForm();
                    });

                    googleMapMarker = new google.maps.Marker({
                        position:           new google.maps.LatLng(latitude, longitude),
                        clickable:          false,
                        draggable:          true,
                        map:                googleMap
                    });
                    google.maps.event.addListener(googleMapMarker, 'dragend', function() {
                        var latLng = googleMapMarker.getPosition();
                        latitude = latLng.lat();
                        longitude = latLng.lng();

                        sendPositionToForm();
                        googleMap.setCenter(latLng);
                    });
                } catch(exception) {
                    googleMap = null;
                    showErrorMessage(failedToLoad);
                }
            }
        };
    </script>
</body>
</html>